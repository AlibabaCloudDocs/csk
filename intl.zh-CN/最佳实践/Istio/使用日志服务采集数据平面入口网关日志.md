# 使用日志服务采集数据平面入口网关日志

容器服务ACK（Alibaba Cloud Container Service for Kubernetes）集成了日志服务功能，您可在创建集群时启用日志服务，采集服务网格数据平面集群入口网关的访问日志。本文主要介绍如何开启日志采集、配置日志服务以及查看采集的日志。

-   已创建至少一个ASM实例，请参见[创建ASM实例]()。
-   已添加至少一个ACK集群至ASM实例，请参见[添加集群到ASM实例]()。
-   已部署至少一个入口网关到ACK集群，请参见[添加入口网关服务]()。

## 步骤一：为Kubernetes集群安装日志服务组件

**如果您尚未创建Kubernetes集群，请执行以下步骤。**

1.  登录[容器服务管理控制台](https://cs.console.aliyun.com)。

2.  在控制台左侧导航栏中，单击**集群**。

3.  在**集群列表**页面，单击右上角**创建Kubernetes集群**，具体步骤，请参见[快速创建Kubernetes托管版集群](/intl.zh-CN/快速入门/基础入门/快速创建Kubernetes托管版集群.md)。

4.  在**组件配置**步骤中，选择**日志服务**配置项，表示在新建的Kubernetes集群中安装日志插件。

    -   选择**使用已有Project**，选择一个现有的Project来管理采集的日志。

        ![开启日志1](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8005219951/p100622.png)

    -   选择**创建新Project**，则自动创建一个新的Project来管理采集的日志，Project会自动命名为k8s-log-\{ClusterID\}，ClusterID表示您新建的Kubernetes集群的唯一标识。

        ![开启日志2](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9005219951/p100624.png)

5.  完成配置后，单击**创建集群**，完成集群创建。


**如果您已创建了Kubernetes集群，但未安装日志组件，请执行以下步骤。**

1.  登录[容器服务管理控制台](https://cs.console.aliyun.com)。

2.  在控制台左侧导航栏中，单击**集群**。

3.  在集群列表页面中，单击目标集群名称或者目标集群右侧**操作**列下的**详情**。

4.  在集群管理页左侧导航栏中，单击**运维管理** \> **组件管理**。

5.  在**可选组件**列表中找到**logtail-ds**，单击**安装**。


**如果您已经创建了Kubernetes集群，并且已为集群安装了日志组件，但版本低于v0.16.24.0-1fa7551-aliyun，请执行以下步骤。**

1.  登录[容器服务管理控制台](https://cs.console.aliyun.com)。

2.  在控制台左侧导航栏中，单击**集群**。

3.  在集群列表页面中，单击目标集群名称或者目标集群右侧**操作**列下的**详情**。

4.  在集群管理页左侧导航栏中，单击**运维管理** \> **组件管理**。

5.  在**可选组件**列表中找到**logtail-ds**，单击右侧的**升级**。


## 步骤二：配置日志服务

使用logtail组件采集入口网关日志，需要创建采集配置。

**如果您的ASM为v1.7.5.26-gd318a562-aliyun及以上版本，需要按照以下步骤操作**

1.  登录[ASM控制台](https://servicemesh.console.aliyun.com)。

2.  在左侧导航栏，选择**服务网格** \> **网格管理**。

3.  在**网格管理**页面，找到待配置的实例，单击实例的名称或在**操作**列中单击**管理**。

4.  在网格管理详情页面单击右上角的**功能设置**。

5.  在**功能设置更新**面板中选中**启用访问日志查询**，然后单击**确定**。


**如果您的ASM版本低于v1.7.5.26-gd318a562-aliyun，需要按照以下步骤操作**

1.  创建YAML文件，文件模板如下。

    **说明：** 您需要为每个数据平面集群准备配置文件。

    ```
    apiVersion: log.alibabacloud.com/v1alpha1
    kind: AliyunLogConfig
    metadata:
      # your config name, must be unique in you k8s cluster
      name: mesh-ingress-log-config
      namespace: kube-system
    spec:
      project: k8s-log-${K8SClusterId}
      # logstore name to upload log
      logstore: mesh-ingress-log
      # product code, you should not change it
      productCode: k8s-istio-ingress
      # logtail config detail
      logtailConfig:
        inputType: plugin
        configName: mesh-ingress-log-config
        inputDetail:
          plugin:
            inputs:
            - detail:
                IncludeLabel:
                  io.kubernetes.pod.name: ^istio-ingressgateway-.*$
                Stderr: false
                Stdout: true
              type: service_docker_stdout
            processors:
            - detail:
                Anchors:
                - FieldName: log
                  FieldType: json
                KeepSource: true
                NoKeyError: true
                NoMatchError: true
                SourceKey: content
              type: processor_anchor
            - type: processor_rename
              detail:
                DestKeys:
                - host
                - request_length
                - body_bytes_sent
                - request_time
                - method
                - url
                - version
                - req_id
                - status
                - proxy_upstream_name
                - upstream_addr
                - upstream_response_time
                - http_user_agent
                - x_forward_for
                SourceKeys:
                - log_authority
                - log_bytes_received
                - log_bytes_sent
                - log_duration
                - log_method
                - log_path
                - log_protocol
                - log_request_id
                - log_response_code
                - log_upstream_cluster
                - log_upstream_host
                - log_upstream_service_time
                - log_user_agent
                - log_x_forwarded_for
    ```

2.  替换模板中的$\{K8SClusterID\}为您的Kubernetes集群ClusterID。

3.  若您存在未经过服务网格控制台创建的入口网关，且您希望采集该入口网关的日志，则您需要按照以下格式修改模板中io.kubernetes.pod.name的参数值。

    ```
    ^(^istio-ingressgateway-.*$)|(^[Name-of-your-customized-ingressgateway]-.*$)$
    ```

    例如Ingressgateway deployment名称为my-ingressgateway，则您需要按照以下格式修改模板中io.kubernetes.pod.name的参数值。

    ```
    ^(^istio-ingressgateway-.*$)|(^my-ingressgateway-.*$)$
    ```

4.  连接到Kubernetes集群，详细描述请参见[通过kubectl连接Kubernetes集群](/intl.zh-CN/Kubernetes集群用户指南/集群管理/连接集群/通过kubectl连接Kubernetes集群.md)或[通过SSH访问Kubernetes集群](/intl.zh-CN/Kubernetes集群用户指南/集群管理/连接集群/通过SSH访问Kubernetes集群.md)。

5.  在Kubernetes集群应用已完成的YAML文件。

    ```
    kubectl apply -f [yaml文件路径]
    ```


## 步骤三：查看日志

完成配置后，将采集数据平面入口网关日志并存储到日志服务指定的LogProject和LogStore，您可以通过以下步骤查看日志。

1.  登录[ASM控制台](https://servicemesh.console.aliyun.com)。

2.  在左侧导航栏，选择**服务网格** \> **网格管理**。

3.  在**网格管理**页面，找到待配置的实例，单击实例的名称或在**操作**列中单击**管理**。

4.  单击数据平面集群列表中的**查看报表**，可选择查看**入口网关概览**、**入口网关访问中心**、**入口网关监控中心**。

    ![查看报表](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7005219951/p120561.png)

    -   选择**入口网关概览**，进入入口网关概览界面。该界面展示了网格入口的统计信息概览，包括访问地理、PV/UV、延迟、成功率等。

        ![网关概览](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7005219951/p133385.png)

    -   选择**入口网关访问中心**，进入入口网关访问中心界面。该界面详细展示了PV/UV、地理位置、访问来源设备等统计信息，对判断用户分布、行为有参考意义。

        ![网关访问中心](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7005219951/p133390.png)

    -   选择**入口网关监控中心**，进入入口网关监控中心界面。该界面展示了成功率、请求状态码、延迟等信息，对判断当前服务状态有重要参考意义。

        ![网关监控中心](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7005219951/p133391.png)


